<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflex Trainer - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        .bg-matte-black { background-color: #121212; }
        .bg-matte-gray { background-color: #1E1E1E; }
        .text-accent { color: #D97706; }
        .bg-accent { background-color: #D97706; }
        .hover\:bg-accent-dark:hover { background-color: #B45309; }
        .border-accent { border-color: #D97706; }
    </style>
</head>
<body class="bg-matte-black text-gray-200 flex items-center justify-center min-h-screen">

    <!-- Live User Count -->
    <div id="userCountContainer" class="absolute top-4 right-4 bg-matte-gray text-white py-2 px-4 rounded-lg flex items-center gap-2 border border-gray-700">
        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
        <span id="userCount">1</span>
        <span>Online</span>
    </div>

    <!-- Main App -->
    <div id="appContainer" class="text-center p-8 bg-matte-gray rounded-xl shadow-2xl w-full max-w-md mx-4 border border-gray-700 transition-opacity duration-500">
        <!-- Header -->
        <h1 class="text-4xl font-bold text-accent mb-4">Reflex Trainer</h1>
        <p class="text-gray-400 mb-8">Press Start. Dominate the reaction.</p>
        <div id="commandDisplay" class="text-7xl font-bold my-12 h-24 flex items-center justify-center text-gray-100 transition-opacity duration-300">--</div>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <button id="startButton" class="w-full sm:w-auto bg-accent hover:bg-accent-dark text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors duration-300 focus:outline-none">Start</button>
            <button id="stopButton" class="w-full sm:w-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors duration-300 focus:outline-none" disabled>Stop</button>
        </div>
        <div class="mt-12 text-left text-gray-300 bg-gray-800/50 p-6 rounded-lg border border-gray-700">
            <h2 class="text-2xl font-semibold mb-3 text-white">Execution</h2>
            <ul class="list-disc list-inside space-y-2">
                <li><strong class="text-accent">"One":</strong> Left Hand Strike</li>
                <li><strong class="text-accent">"Two":</strong> Right Hand Strike</li>
                <li><strong class="text-accent">"One-Two":</strong> Left then Right Strike</li>
            </ul>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- DOM Elements ---
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const commandDisplay = document.getElementById('commandDisplay');
        const userCount = document.getElementById('userCount');
        const userCountContainer = document.getElementById('userCountContainer');
        const appContainer = document.getElementById('appContainer');

        // --- State ---
        let trainingInterval = null;
        let isRunning = false;
        const commands = ['one', 'two', 'one-two']; // Simplified commands
        let userId = null;
        let audioUnlocked = false; // MOBILE FIX: State to track if audio is unlocked
        
        // --- App Configuration ---
        // IMPORTANT: Replace these with your own Firebase project configuration to enable the live user count.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // --- FIX: Check if Firebase config is valid before using it ---
        const isFirebaseConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY";

        if (isFirebaseConfigured) {
            try {
                // --- Initialize Firebase ---
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                // --- Presence System (Live Count) ---
                function updateUserPresence(uid) {
                    const userStatusRef = doc(db, "presence", uid);
                    setDoc(userStatusRef, { online: true });
                }

                function removeUserPresence(uid) {
                    if (!uid) return;
                    const userStatusRef = doc(db, "presence", uid);
                    deleteDoc(userStatusRef);
                }

                const presenceRef = collection(db, "presence");
                onSnapshot(presenceRef, (snapshot) => {
                    const count = snapshot.size;
                    userCount.textContent = count > 0 ? count : 1;
                });

                // --- Authentication & App Start ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        updateUserPresence(userId);
                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Firebase sign-in failed:", error);
                            userCountContainer.innerHTML = '<span class="text-red-400">Login Error</span>';
                        });
                    }
                });

                // Handle user leaving the page
                window.addEventListener('beforeunload', () => {
                    removeUserPresence(userId);
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userCountContainer.style.display = 'none';
            }
        } else {
            // --- Firebase Not Configured ---
            userCountContainer.style.display = 'none';
            console.warn("Firebase is not configured. Live user count is disabled. Add your Firebase config to enable this feature.");
        }


        // --- MOBILE AUDIO UNLOCK ---
        function unlockAudio() {
            if (audioUnlocked) return;
            synth.speak(new SpeechSynthesisUtterance(''));
            audioUnlocked = true;
            console.log("Audio context unlocked for mobile.");
        }

        // --- Speech Synthesis ---
        const synth = window.speechSynthesis;
        let tateVoice = null;
        
        function setVoice() {
            const voices = synth.getVoices();
            tateVoice = voices.find(v => v.name.includes('Google UK English Male') || v.name.includes('Daniel')) || voices.find(v => v.lang.includes('en') && v.name.toLowerCase().includes('male')) || voices.find(v => v.lang.includes('en'));
        }
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = setVoice;
        }
        setVoice();

        function speak(text) {
            if (synth.speaking) return;
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.voice = tateVoice;
            utterThis.volume = 1;
            utterThis.pitch = 0.9;
            utterThis.rate = 1.1;
            synth.speak(utterThis);
        }

        // --- Training Core Logic ---
        function runCommand() {
            const randomIndex = Math.floor(Math.random() * commands.length);
            const command = commands[randomIndex];
            commandDisplay.textContent = command;
            commandDisplay.classList.remove('opacity-0');
            speak(command);
            setTimeout(() => commandDisplay.classList.add('opacity-0'), 1000);
        }

        function scheduleNextCommand() {
            if (trainingInterval) clearTimeout(trainingInterval);
            const randomDelay = Math.random() * 3000 + 2000;
            trainingInterval = setTimeout(() => {
                runCommand();
                if (isRunning) scheduleNextCommand();
            }, randomDelay);
        }

        function startTraining() {
            unlockAudio(); // <<< MOBILE FIX: Unlock audio on the first tap of the start button.
            if (isRunning) return;
            isRunning = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            commandDisplay.textContent = "Get Ready...";
            commandDisplay.classList.remove('opacity-0');
            setTimeout(() => {
                commandDisplay.classList.add('opacity-0');
                scheduleNextCommand();
            }, 2000);
        }

        function stopTraining() {
            if (!isRunning) return;
            isRunning = false;
            clearTimeout(trainingInterval);
            trainingInterval = null;
            synth.cancel();
            commandDisplay.textContent = '--';
            commandDisplay.classList.remove('opacity-0');
            startButton.disabled = false;
            stopButton.disabled = true;
        }

        startButton.addEventListener('click', startTraining);
        stopButton.addEventListener('click', stopTraining);
    </script>
</body>
</html>
